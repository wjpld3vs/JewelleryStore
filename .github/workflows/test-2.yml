name: "ðŸ” AnÃ¡lisis EstÃ¡tico de CÃ³digo .NET"
on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: "CodeQL - AnÃ¡lisis de Seguridad C#"
    runs-on: self-hosted
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: "ðŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4
      
    - name: "ðŸ› ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: | 
          8.x
          7.x
          6.x
          
    - name: "ðŸ› ï¸ Inicializar CodeQL"
      uses: github/codeql-action/init@v3
      with:
        languages: 'csharp'
        queries: security-extended,security-and-quality
        build-mode: manual  # Para .NET necesitamos build manual
        
    - name: "ðŸ—ï¸ Restaurar dependencias .NET"
      run: |
        # Restaurar paquetes NuGet para permitir anÃ¡lisis preciso
        dotnet restore --verbosity minimal
        dotnet build --no-restore --configuration Release
      
    - name: "ðŸ”¬ Ejecutar AnÃ¡lisis CodeQL"
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:csharp"

  security-scan-dotnet:
    name: "Security Code Scan - AnÃ¡lisis C#"
    runs-on: windows-latest
    
    steps:
    - name: "ðŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4
      
    - name: "ðŸ› ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
        
    - name: "ðŸ” Instalar Security Code Scan"
      run: |
        # Instalar el analizador de seguridad para .NET
        dotnet tool install --global SecurityCodeScan.VS2019 --version 5.6.6
        
    - name: "ðŸ›¡ï¸ Ejecutar Security Code Scan"
      run: |
        # Ejecutar anÃ¡lisis de seguridad en todos los proyectos
        Get-ChildItem -Recurse -Filter "*.csproj" | ForEach-Object {
          Write-Host "Analizando proyecto: $($_.Name)"
          dotnet build $_.FullName --verbosity minimal /p:SecurityCodeScanEnabled=true
        }
        
    - name: "ðŸ“Š Reporte de Vulnerabilidades C#"
      run: |
        echo "## ðŸ›¡ï¸ AnÃ¡lisis de Seguridad .NET" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Proyectos Analizados:" >> $GITHUB_STEP_SUMMARY
        Get-ChildItem -Recurse -Filter "*.csproj" | ForEach-Object {
          echo "- $($_.Name)" >> $GITHUB_STEP_SUMMARY
        }
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Herramientas utilizadas:**" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub CodeQL para C#" >> $GITHUB_STEP_SUMMARY
        echo "- Security Code Scan" >> $GITHUB_STEP_SUMMARY

  roslyn-analyzers:
    name: "Analizadores Roslyn - Calidad CÃ³digo"
    runs-on: windows-latest
    
    steps:
    - name: "ðŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4
      
    - name: "ðŸ› ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
        
    - name: "ðŸ”§ Ejecutar Analizadores Roslyn"
      run: |
        # Build con todos los warnings tratados como errores
        dotnet build --configuration Release --verbosity normal /warnaserror
        
    - name: "ðŸ“ Ejecutar AnÃ¡lisis de CÃ³digo"
      run: |
        # AnÃ¡lisis estÃ¡tico usando dotnet format
        dotnet format --verify-no-changes --severity info
        
    - name: "ðŸ’¾ Guardar Reporte de AnÃ¡lisis"
      uses: actions/upload-artifact@v4
      with:
        name: roslyn-analysis-results
        path: bin/Release/
        retention-days: 7

  dotnet-specific-checks:
    name: "Chequeos EspecÃ­ficos .NET"
    runs-on: windows-latest
    
    steps:
    - name: "ðŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4
      
    - name: "ðŸ› ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
        
    - name: "ðŸ”Ž Buscar Patrones Peligrosos C#"
      run: |
        # Script PowerShell para buscar patrones comunes de vulnerabilidades en C#
        $patterns = @{
          "SqlCommand con concatenaciÃ³n" = 'SqlCommand.*\+'
          "Command Injection" = 'Process\.Start.*\+'
          "Path Injection" = 'Path\.Combine.*\+'
          "DeserializaciÃ³n insegura" = 'BinaryFormatter|SoapFormatter'
          "ContraseÃ±as hardcodeadas" = 'password.*=.*".*"'
        }
        
        echo "## ðŸ” Patrones de Seguridad Encontrados" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        foreach ($pattern in $patterns.GetEnumerator()) {
          $results = Select-String -Path "*.cs" -Pattern $pattern.Value
          if ($results) {
            echo "### $($pattern.Key):" >> $GITHUB_STEP_SUMMARY
            foreach ($result in $results) {
              echo "- $($result.Filename):$($result.LineNumber) - $($result.Line.Trim())" >> $GITHUB_STEP_SUMMARY
            }
            echo "" >> $GITHUB_STEP_SUMMARY
          }
        }